---
title: "Terraformã§keycloakã®è¨­å®šã‚’è‰²ã€…æŠ•å…¥ã™ã‚‹è©±"
emoji: "ğŸ™"
type: "tech"
topics: ["Keycloak", "Terraform"]
published: false
---

# ã¯ã˜ã‚ã«
ã“ã®è¨˜äº‹ã¯terraform Advent Calendar 2021ã®14æ—¥ç›®ã§ã™ã€‚  
AWSã‚„GCPãªã©ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã¸åˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„Terraformã§ã™ãŒã€ã“ã®è¨˜äº‹ã§ã¯keycloakã®è¨­å®šã«ã¤ã„ã¦æ›¸ã„ã¦ã„ãã¾ã™ã€‚  
è›‡è¶³ã§ã™ãŒã€Keycloakã¨ã¯OSSã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ»ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ã™ã€‚

# keycloak providerã«ã¤ã„ã¦
å°å…¥æ–¹æ³•ãªã©ã¯ã€[keycloak providerã®ãƒšãƒ¼ã‚¸](https://registry.terraform.io/providers/mrparkers/keycloak/latest)ã‚’ã”è¦§ãã ã•ã„ã€‚
ä¸€ãƒ¶æœˆã»ã©å‰ã«æ›´æ–°ãŒãªã•ã‚Œã¦ã„ã‚‹ã®ã§ã€å¤ã„ã®ã§ä½¿ãˆãªã„ã¨ã„ã†ã“ã¨ã¯ãªã„ã‹ãªã¨æ€ã„ã¾ã™ï¼ˆ2021å¹´12æœˆç¾åœ¨ï¼‰

# ã„ãã¤ã‹æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ã¿ã‚‹
## ãƒ™ãƒ¼ã‚¹éƒ¨åˆ†ã®è¨­å®šã‚’æŠ•å…¥ã™ã‚‹
ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ç®¡ç†è€…æ¨©é™ãƒ¦ãƒ¼ã‚¶ã®ä½œæˆï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼‰ã¨Master realmãŒä½œæˆã•ã‚Œã¾ã™ã€‚  
ã¾ãŸã€internationalizationã®supported_localesã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§è¨€èªè¨­å®šãŒã§ãã¾ã™ã€‚
```
terraform {
  required_version = "~> 0.13"

  required_providers {
    keycloak = {
      source  = "mrparkers/keycloak"
      version = "~> 2.0"
    }
  }
}

provider "keycloak" {
  url       = "http://keycloak:8080"
  client_id = "admin-cli"
  username  = "admin"
  password  = "admin"
}

resource "keycloak_realm" "master" {
  realm = "master"

  internationalization {
    supported_locales = [
      "ja",
      "en",
    ]
    default_locale = "ja"
  }
}
```

## realmä½œæˆã¨ãƒ¦ãƒ¼ã‚¶ç™»éŒ²
è©¦ã—ã«ãƒ†ã‚¹ãƒˆç”¨realmã¨ãƒ¦ãƒ¼ã‚¶ã®ç™»éŒ²ã‚’è¡Œãªã£ã¦ã¿ã¾ã™ã€‚
```
resource "keycloak_realm" "test_realm" {
  realm = "test_realm"
}

resource "keycloak_user" "test_user" {
  realm_id = keycloak_realm.test_realm.id
  username = "mendako"
  enabled = true

  email = "Mendako@sample.email.address.io"
  first_name = "Opisthoteuthis"
  last_name = "Depressa"

}
```

## OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆã™ã‚‹
keycloakã§ã¯ã€OIDCã‚’åˆ©ç”¨ã—ã¦èªè¨¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ 
ã“ã“ã§ã¯localhost:8000ã§å‹•ä½œã—ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¦ã€OIDCã§ã®èªè¨¼ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’åˆ©ç”¨ã—ã¦è¡Œã†å ´åˆã®è¨­å®šã‚’ä¾‹ã«ã—ã¾ã™ã€‚  
ãªãŠã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’åˆ©ç”¨ã—ãªã„èªè¨¼æ–¹æ³•ã‚‚`access_type`ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§è¨­å®šå¯èƒ½ã§ã™ï¼ˆè©³ç´°ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”è¦§ãã ã•ã„ï¼‰
```
resource "keycloak_openid_client" "openid_client" {
  realm_id            = keycloak_realm.master.id
  client_id           = "testapp"
  name                = "test_client"
  enabled             = true
  access_type         = "CONFIDENTIAL"
  standard_flow_enabled = "true"
  implicit_flow_enabled = "true"

  root_url = "http://localhost:8000"
  admin_url = "http://localhost:8000"
  web_origins = ["http://localhost:8000"]
  valid_redirect_uris = [
    "http://localhost:8000/*"
  ]

  login_theme = "keycloak"
}
```

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å‹•ã‹ã—ã¦ã¿ã‚‹
[åˆ¥ã®è¨˜äº‹](https://zenn.dev/guranytou/articles/d0c3ce9cefe29418f062)ã§è»½ãç´¹ä»‹ã—ã¾ã—ãŸãŒã€keycloak&terraformã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã™ç’°å¢ƒã‚’docker-composeã§ä½œæˆã—ã¾ã—ãŸã€‚  
`terraform/main.tf`ã§è‰²ã€…ãªè¨­å®šå¤‰æ›´ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

# ãŠã‚ã‚Šã«
ã–ã£ãã‚Šã¨ã§ã™ãŒã„ãã¤ã‹ã®æƒ…å ±ã‚’æŠ•å…¥ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ã¾ã—ãŸã€‚
ã¡ãªã¿ã«ã§ã™ãŒã€keycloakã§ã¯realm.jsonã‚’åˆ©ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§è¨­å®šã‚’æŠ•å…¥ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  
ã§ã™ãŒã€Terraformã‚’åˆ©ç”¨ã—ãŸæ–¹ãŒäººé–“ãŒç®¡ç†ã—ã‚„ã™ã„&å¯èª­æ€§ãŒé«˜ãä¿ã¦ã‚‹ã®ã§ã¯ãªã„ã‹ãªã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚  
Terraformã«ã¯ä»–ã«ã‚‚è‰²ã€…ãªProviderãŒã‚ã‚‹ã®ã§ã€è©¦ã—ã¦ã¿ãŸã„ãªã¨æ€ã†ã®ã¨åŒæ™‚ã«ã€ä¸€åº¦ã¯Providerã‚’ä½œã£ã¦ã¿ãŸã„ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚