---
title: "yamlã§ä½œã£ãŸIPãƒªã‚¹ãƒˆã‚’AWSã®SGã«é©ç”¨ã—ã¦ã¿ã‚‹"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "Terraform"]
published: false
---

## ã¯ã˜ã‚ã«
TFã¨ãã®ã»ã‹ã®IaCãƒ„ãƒ¼ãƒ«ã§è¨±å¯ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªã‚¹ãƒˆã‚’å…±æœ‰ã—ãŸã‹ã£ãŸã®ã§ã€yamlãªã‚‰TFå´ã‚‚ã„ã„æ„Ÿã˜ã«ã§ãã‚‹ã®ã§ã¯ï¼Ÿã¨æ€ã„è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚  
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚  
https://github.com/guranytou/tf-yaml-sandbox

## ã‚µã‚¯ãƒƒã¨é©ç”¨ã—ã¦ã¿ã‚‹
ã¾ãšã¯ç°¡å˜ãªãƒªã‚¹ãƒˆã‚’ç”¨æ„ã—ã¦SGãƒ«ãƒ¼ãƒ«ã«é©ç”¨ã—ã¦ã¿ã¾ã™ã€‚  
```yml: list1.yml
- 192.168.0.1/32
- 192.168.0.2/32
- 192.168.0.3/32
```

```hcl: main.tf
resource "aws_security_group_rule" "ingress_example1" {
  type              = "ingress"
  from_port         = 80
  to_port           = 80
  protocol          = "tcp"
  cidr_blocks       = yamldecode(file("list1.yml"))
  security_group_id = aws_security_group.example1.id
}
```

plançµæœã‚’ç¢ºèªã™ã‚‹ã¨ã€ãƒªã‚¹ãƒˆã®é€šã‚Šã«ingressãƒ«ãƒ¼ãƒ«ãŒä½œæˆã§ããŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
```bash
  # aws_security_group_rule.ingress_example1 will be created
  + resource "aws_security_group_rule" "ingress_example1" {
      + cidr_blocks              = [
          + "192.168.0.1/32",
          + "192.168.0.2/32",
          + "192.168.0.3/32",
        ]
      + from_port                = 80
      + id                       = (known after apply)
      + protocol                 = "tcp"
      + security_group_id        = (known after apply)
      + self                     = false
      + source_security_group_id = (known after apply)
      + to_port                  = 80
      + type                     = "ingress"
    }
```

## å®Ÿç”¨ã§ãã‚‹ãƒªã‚¹ãƒˆã¨SGãƒ«ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹
å®Ÿéš›ã«é‹ç”¨ã§ä½¿ã†å ´åˆã€ã€Œã“ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã“ã®å ´æ‰€ã®ã‚‚ã®ã€ã¨ã„ã†èª¬æ˜ã‚’ä»˜è¨˜ã—ãŸããªã‚‹ã¨æ€ã„ã¾ã™ã€‚  
ãã“ã§ãƒªã‚¹ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç”¨æ„ã—ã€TFã§SGãƒ«ãƒ¼ãƒ«ã«é©ç”¨ã—ã¦ã¿ã¾ã™ã€‚
```yml: list2.yml
IP-Adress-list-A:
  - 192.168.0.1/32
  - 192.168.0.2/32
  - 192.168.0.3/32

IP-Adress-list-B:
  - 10.0.0.0/24
  - 10.0.1.0/24
```

```hcl: main.tf
resource "aws_security_group_rule" "ingress_example2" {
  for_each          = yamldecode(file("list2.yml"))
  type              = "ingress"
  from_port         = 80
  to_port           = 80
  protocol          = "tcp"
  cidr_blocks       = each.value
  description       = each.key
  security_group_id = aws_security_group.example2.id
}
```

plançµæœã‚’ç¢ºèªã™ã‚‹ã¨ã€æ„å›³ã—ãŸé€šã‚Šã«keyæ¯ã«ãƒ«ãƒ¼ãƒ«ãŒä½œæˆã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
```bash
  # aws_security_group_rule.ingress_example2["IP-Adress-list-A"] will be created
  + resource "aws_security_group_rule" "ingress_example2" {
      + cidr_blocks              = [
          + "192.168.0.1/32",
          + "192.168.0.2/32",
          + "192.168.0.3/32",
        ]
      + description              = "IP-Adress-list-A"
      + from_port                = 80
      + id                       = (known after apply)
      + protocol                 = "tcp"
      + security_group_id        = (known after apply)
      + self                     = false
      + source_security_group_id = (known after apply)
      + to_port                  = 80
      + type                     = "ingress"
    }

  # aws_security_group_rule.ingress_example2["IP-Adress-list-B"] will be created
  + resource "aws_security_group_rule" "ingress_example2" {
      + cidr_blocks              = [
          + "10.0.0.0/24",
          + "10.0.1.0/24",
        ]
      + description              = "IP-Adress-list-B"
      + from_port                = 80
      + id                       = (known after apply)
      + protocol                 = "tcp"
      + security_group_id        = (known after apply)
      + self                     = false
      + source_security_group_id = (known after apply)
      + to_port                  = 80
      + type                     = "ingress"
    }
```
