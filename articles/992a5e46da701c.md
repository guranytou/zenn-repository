---
title: "Pulumi&Goã‚’åˆ©ç”¨ã—ã¦AWSä¸Šã§Webã‚µãƒ¼ãƒä¸€å¼ã‚’ç«‹ã¦ã¦ã¿ãŸ"
emoji: "ğŸŒ±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Pulumi", "Go", "AWS"]
published: true
---

# ã¯ã˜ã‚ã«
æ™®æ®µã¯Terraformã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€Pulumiã ã£ãŸã‚ŠSDKã ã£ãŸã‚Šã€æ±ç”¨è¨€èªã‚’ä½¿ã£ã¦AWSãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã£ã¦ã¿ãŸã‹ã£ãŸã®ã§ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚  
è¨€èªã¯ç¾åœ¨å‹‰å¼·ã—ã¦ã„ã‚‹Goã‚’ä½¿ã„ã¾ã—ãŸã€‚  

# ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚„ã£ãŸè¨˜äº‹
ä»¥å‰ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚„ã£ãŸè©±ã‚’å€‹äººãƒ–ãƒ­ã‚°ã«æ›¸ã„ãŸã®ã§å‚è€ƒã¾ã§ã«è¨˜è¼‰ã—ã¾ã™ã€‚  
https://guranytou.github.io/blog/post/20220523-create-aws-resource-use-pulumi-1/

# å®Ÿè£…ã«ã¤ã„ã¦
å®Ÿéš›ã«ALB-EC2ã§Webã‚µãƒ¼ãƒã‚’ç«‹ã¦ã¦ã¿ã¾ã—ãŸã€‚ãªãŠæ§‹æˆå›³ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ãŒç½®ã„ã¦ã‚ã‚‹ãƒªãƒã‚¸ãƒˆãƒªï¼š https://github.com/guranytou/pulumi-ec2-alb

## ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®
ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ã„ã¾ã™ã€‚
```
â”œâ”€â”€ main.go
â”œâ”€â”€ network.go
â””â”€â”€ application.go
```

## å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ç°¡å˜ãªè§£èª¬
### network.go
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é–¢ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
```go: network.go
package main

import (
	"github.com/pulumi/pulumi-aws/sdk/v5/go/aws/ec2"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi"
)

type Network struct {
	VpcID           pulumi.IDOutput
	PublicSubnetIDs []pulumi.IDOutput
	PrivateSubnetID pulumi.IDOutput
}

func createNetwork(ctx *pulumi.Context) (*Network, error) {
	vpc, err := ec2.NewVpc(ctx, "example_vpc", &ec2.VpcArgs{
		CidrBlock: pulumi.String("10.100.0.0/16"),
		Tags: pulumi.StringMap{
			"Name": pulumi.String("example_vpc"),
		},
	})
	if err != nil {
		return nil, err
	}

	var pubSubIDs []pulumi.IDOutput
	pubSub1a, err := ec2.NewSubnet(ctx, "pubSub1a", &ec2.SubnetArgs{
		VpcId:            vpc.ID(),
		CidrBlock:        pulumi.String("10.100.0.0/24"),
		AvailabilityZone: pulumi.String("ap-northeast-1a"),
		Tags: pulumi.StringMap{
			"Name": pulumi.String("example_public_1a"),
		},
	})
	if err != nil {
		return nil, err
	}

	pubSubIDs = append(pubSubIDs, pubSub1a.ID())

	pubSub1c, err := ec2.NewSubnet(ctx, "pubSub1c", &ec2.SubnetArgs{
		VpcId:            vpc.ID(),
		CidrBlock:        pulumi.String("10.100.1.0/24"),
		AvailabilityZone: pulumi.String("ap-northeast-1c"),
		Tags: pulumi.StringMap{
			"Name": pulumi.String("example_public_1c"),
		},
	})
	if err != nil {
		return nil, err
	}

	pubSubIDs = append(pubSubIDs, pubSub1c.ID())

	priSub1a, err := ec2.NewSubnet(ctx, "priSub1a", &ec2.SubnetArgs{
		VpcId:            vpc.ID(),
		CidrBlock:        pulumi.String("10.100.100.0/24"),
		AvailabilityZone: pulumi.String("ap-northeast-1a"),
		Tags: pulumi.StringMap{
			"Name": pulumi.String("example_private_1a"),
		},
	})
	if err != nil {
		return nil, err
	}

	eip, err := ec2.NewEip(ctx, "eip", &ec2.EipArgs{
		Vpc: pulumi.Bool(true),
	})
	if err != nil {
		return nil, err
	}

	igw, err := ec2.NewInternetGateway(ctx, "igw", &ec2.InternetGatewayArgs{
		VpcId: vpc.ID(),
		Tags: pulumi.StringMap{
			"Name": pulumi.String("example_igw"),
		},
	})
	if err != nil {
		return nil, err
	}

	natgw, err := ec2.NewNatGateway(ctx, "natgw", &ec2.NatGatewayArgs{
		AllocationId: eip.ID(),
		SubnetId:     pubSub1a.ID(),
	}, pulumi.DependsOn([]pulumi.Resource{eip}))
	if err != nil {
		return nil, err
	}

	pubRoutaTable, err := ec2.NewRouteTable(ctx, "pubRouteTable", &ec2.RouteTableArgs{
		VpcId: vpc.ID(),
		Tags: pulumi.StringMap{
			"Name": pulumi.String("example_route_table_public"),
		},
	})
	if err != nil {
		return nil, err
	}

	_, err = ec2.NewRoute(ctx, "pubRoute", &ec2.RouteArgs{
		RouteTableId:         pubRoutaTable.ID(),
		DestinationCidrBlock: pulumi.String("0.0.0.0/0"),
		GatewayId:            igw.ID(),
	})
	if err != nil {
		return nil, err
	}

	_, err = ec2.NewRouteTableAssociation(ctx, "pubRoute1a", &ec2.RouteTableAssociationArgs{
		SubnetId:     pubSub1a.ID(),
		RouteTableId: pubRoutaTable.ID(),
	})
	if err != nil {
		return nil, err
	}

	_, err = ec2.NewRouteTableAssociation(ctx, "pubRoute1c", &ec2.RouteTableAssociationArgs{
		SubnetId:     pubSub1c.ID(),
		RouteTableId: pubRoutaTable.ID(),
	})
	if err != nil {
		return nil, err
	}

	priRouteTable, err := ec2.NewRouteTable(ctx, "priRouteTable", &ec2.RouteTableArgs{
		VpcId: vpc.ID(),
		Tags: pulumi.StringMap{
			"Name": pulumi.String("example_route_table_private"),
		},
	})
	if err != nil {
		return nil, err
	}

	_, err = ec2.NewRoute(ctx, "priRoute", &ec2.RouteArgs{
		RouteTableId:         priRouteTable.ID(),
		DestinationCidrBlock: pulumi.String("0.0.0.0/0"),
		NatGatewayId:         natgw.ID(),
	})
	if err != nil {
		return nil, err
	}

	_, err = ec2.NewRouteTableAssociation(ctx, "priRoute1a", &ec2.RouteTableAssociationArgs{
		SubnetId:     priSub1a.ID(),
		RouteTableId: priRouteTable.ID(),
	})
	if err != nil {
		return nil, err
	}

	network := new(Network)
	network.VpcID = vpc.ID()
	network.PublicSubnetIDs = pubSubIDs
	network.PrivateSubnetID = priSub1a.ID()

	return network, nil
}
```

### application.go
EC2åŠã³ALBé–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚  
ãªãŠã€EC2ç«‹ã¡ä¸Šã’æ™‚ã«å‘¼ã³å‡ºã™ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿ã¯ `install_apache.sh`ã¨ã—ã¦åˆ¥ã«åˆ‡ã‚Šå‡ºã—ã¦ã„ã¾ã™ã€‚
```go: application.go
package main

import (
	"encoding/base64"
	"io/ioutil"
	"os"

	"github.com/pulumi/pulumi-aws/sdk/v5/go/aws/ec2"
	"github.com/pulumi/pulumi-aws/sdk/v5/go/aws/lb"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi"
)

func createApplication(ctx *pulumi.Context) error {
	network, err := createNetwork(ctx)
	if err != nil {
		return err
	}

	sgForALB, err := ec2.NewSecurityGroup(ctx, "sgForALB", &ec2.SecurityGroupArgs{
		Name:  pulumi.String("example_sg_for_ALB"),
		VpcId: network.VpcID,
		Ingress: ec2.SecurityGroupIngressArray{
			&ec2.SecurityGroupIngressArgs{
				FromPort: pulumi.Int(80),
				ToPort:   pulumi.Int(80),
				Protocol: pulumi.String("tcp"),
				CidrBlocks: pulumi.StringArray{
					pulumi.String("0.0.0.0/0"),
				},
			},
		},
		Egress: ec2.SecurityGroupEgressArray{
			&ec2.SecurityGroupEgressArgs{
				FromPort: pulumi.Int(0),
				ToPort:   pulumi.Int(0),
				Protocol: pulumi.String("-1"),
				CidrBlocks: pulumi.StringArray{
					pulumi.String("0.0.0.0/0"),
				},
			},
		},
	})
	if err != nil {
		return err
	}

	alb, err := lb.NewLoadBalancer(ctx, "ALB", &lb.LoadBalancerArgs{
		Name:             pulumi.String("example"),
		LoadBalancerType: pulumi.String("application"),
		SecurityGroups: pulumi.StringArray{
			sgForALB.ID(),
		},
		Subnets: pulumi.StringArray{
			network.PublicSubnetIDs[0],
			network.PublicSubnetIDs[1],
		},
		Tags: pulumi.StringMap{
			"Name": pulumi.String("example"),
		},
	})
	if err != nil {
		return err
	}

	httpTG, err := lb.NewTargetGroup(ctx, "httpTG", &lb.TargetGroupArgs{
		Name:     pulumi.String("HTTPTG"),
		Port:     pulumi.Int(80),
		Protocol: pulumi.String("HTTP"),
		VpcId:    network.VpcID,
		HealthCheck: lb.TargetGroupHealthCheckArgs{
			Path:     pulumi.String("/"),
			Matcher:  pulumi.String("403"),
			Port:     pulumi.String("80"),
			Protocol: pulumi.String("HTTP"),
		},
	})
	if err != nil {
		return err
	}

	_, err = lb.NewListener(ctx, "listener", &lb.ListenerArgs{
		LoadBalancerArn: alb.Arn,
		Port:            pulumi.Int(80),
		Protocol:        pulumi.String("HTTP"),
		DefaultActions: lb.ListenerDefaultActionArray{
			&lb.ListenerDefaultActionArgs{
				Type:           pulumi.String("forward"),
				TargetGroupArn: httpTG.Arn,
			},
		},
	}, pulumi.DependsOn([]pulumi.Resource{alb}))
	if err != nil {
		return err
	}

	sgForInstance, err := ec2.NewSecurityGroup(ctx, "sgForInstance", &ec2.SecurityGroupArgs{
		Name:  pulumi.String("example_sg_for_instance"),
		VpcId: network.VpcID,
		Ingress: ec2.SecurityGroupIngressArray{
			&ec2.SecurityGroupIngressArgs{
				FromPort: pulumi.Int(80),
				ToPort:   pulumi.Int(80),
				Protocol: pulumi.String("tcp"),
				SecurityGroups: pulumi.StringArray{
					sgForALB.ID(),
				},
			},
		},
		Egress: ec2.SecurityGroupEgressArray{
			&ec2.SecurityGroupEgressArgs{
				FromPort: pulumi.Int(0),
				ToPort:   pulumi.Int(0),
				Protocol: pulumi.String("-1"),
				CidrBlocks: pulumi.StringArray{
					pulumi.String("0.0.0.0/0"),
				},
			},
		},
	})
	if err != nil {
		return err
	}

	f, err := os.Open("install_apache.sh")
	if err != nil {
		return err
	}

	b, err := ioutil.ReadAll(f)
	if err != nil {
		return err
	}

	enc := base64.StdEncoding.EncodeToString(b)

	ins, err := ec2.NewInstance(ctx, "instance", &ec2.InstanceArgs{
		Ami:          pulumi.String("ami-0992fc94ca0f1415a"),
		InstanceType: pulumi.String("t2.micro"),
		SubnetId:     network.PrivateSubnetID,
		VpcSecurityGroupIds: pulumi.StringArray{
			sgForInstance.ID(),
		},
		UserDataBase64: pulumi.String(enc),
	})
	if err != nil {
		return err
	}

	_, err = lb.NewTargetGroupAttachment(ctx, "TGattach", &lb.TargetGroupAttachmentArgs{
		TargetGroupArn: httpTG.Arn,
		TargetId:       ins.ID(),
		Port:           pulumi.Int(80),
	})
	if err != nil {
		return err
	}

	return nil
}
```

### main.go
EC2&ALBã‚’ä½œæˆã™ã‚‹é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
```go: main.go
package main

import (
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi"
)

func main() {
	pulumi.Run(func(ctx *pulumi.Context) error {
		err := createApplication(ctx)
		if err != nil {
			return err
		}
		return nil
	})
}
```

# Goã§æ›¸ã„ã¦ã¿ã¦ã®æ„Ÿæƒ³
Terraformã¨åŒã˜ã‚ˆã†ãªæ„Ÿè¦šã§æ›¸ã‘ã‚‹ã®ã§ã€Terraformæ›¸ã‘ã‚‹äººã¯ãƒ‘ãƒƒã¨æ›¸ã‘ã‚‹ãªã¨æ€ã„ã¾ã—ãŸã€‚
ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’æ±ç”¨è¨€èªã§é¸æŠã™ã‚‹å ´åˆã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§åˆ©ç”¨ã—ã¦ã„ã‚‹è¨€èªã¨åŒã˜è¨€èªã‚’ä½¿ãˆã‚‹ã®ã§ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®çµ±ä¸€æ€§ãŒä¸ŠãŒã‚‹ã®ã¨å­¦ç¿’ã‚³ã‚¹ãƒˆã®åœ§ç¸®ãŒã§ãã‚‹ã®ã‹ãªã‚ã¨æ„Ÿã˜ã¾ã—ãŸã€‚
å€‹äººçš„ã«ã¯å°‘ãªãã¨ã‚‚Goã§æ›¸ãã‚ˆã‚ŠTerraformã§æ›¸ãæ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«ã‹ãªï¼Ÿã¨æ€ã£ãŸã®ã§ã€ç‰¹åˆ¥ãªç†ç”±ãŒãªã„é™ã‚Šã¯Terraformã‚’é¸æŠã—ãã†ã§ã™ã€‚TypeScriptãªã©åˆ¥ã®è¨€èªã ã¨ã¾ãŸé•ã†æ„Ÿæƒ³ãŒå‡ºãã†ã§ã™ã­ã€‚