---
title: "AWS VPC EndpointServiceã®PrivateDNSæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ã‚’Terraformã§è¡Œã†æ–¹æ³•"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Terraform", "AWS"]
published: true
---
# ã“ã®è¨˜äº‹ã®ã‚¹ã‚³ãƒ¼ãƒ—
ã“ã®è¨˜äº‹ã§ã¯AWS PrivateLinkã§PrivateDNSæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹éš›ã«ã€Terraformã§ã©ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‘ã°ã„ã„ã®ã‹ã¾ã¨ã‚ã¾ã—ãŸã€‚
ãªãŠã€ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯VPC Endpoint Service/VPC Endpoint/Route53ã®ã‚‚ã®ã®ã¿è¨˜è¼‰ã—ã¾ã™ã€‚
â€»å‰æã¨ãªã‚‹VPCãªã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚„NLBã«ã¤ã„ã¦ã¯ã“ã®è¨˜äº‹ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚

# è§£èª¬
## VPC Endpoint Serivce
VPC Endpoint Serviceã§PrivateDNSæ©Ÿèƒ½ã‚’æœ‰åŠ¹ã¨ã™ã‚‹ãŸã‚ã«ã¯ã€`private_dns_name`ã«åˆ©ç”¨ã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
```
resource "aws_vpc_endpoint_service" "example" {
  acceptance_required        = false
  network_load_balancer_arns = [aws_lb.example.arn]
  private_dns_name = "åˆ©ç”¨ã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³å"
  depens_on = [aws_lb.example]
}
```

## Route53
VPC Endpoint Serviceã«ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’è¨­å®šã™ã‚‹ã¨TXTãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç™»éŒ²ã«å¿…è¦ãªå„ç¨®æƒ…å ±ãŒå‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’Route53ã«ç™»éŒ²ã—ã¾ã™ã€‚
```
resource "aws_route53_record" "example" {
  zone_id = aws_route53_zone.primary.id
  type = lookup(element(aws_vpc_endpoint_service.example.private_dns_name_configuration, 0), "type")
  name = "${lookup(element(aws_vpc_endpoint_service.example.private_dns_name_configuration, 0), "name")}.åˆ©ç”¨ã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³å"
  records = [lookup(element(aws_vpc_endpoint_service.example.private_dns_name_configuration, 0), "value")]
  ttl = 1800
}
```

## VPC Endpoint
æ¥ç¶šã™ã‚‹VPC Endpointã§VPC EndpointServiceã§æŒ‡å®šã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’åˆ©ç”¨ã—ãŸã„å ´åˆã«ã¯ã€`private_dns_enabled`ã‚’`true`ã«ã—ã¾ã™ã€‚
```
resource "aws_vpc_endpoint" "example" {
  vpc_id            = aws_vpc.main.id
  service_name      = aws_vpc_endpoint_service.example.service_name
  vpc_endpoint_type = "Interface"

  security_group_ids = [
    aws_security_group.example_sg.id,
  ]

  private_dns_enabled = true
}
```

# ãŠã‚ã‚Šã«
VPCé–“ã‚’æ¥ç¶šã™ã‚‹éš›ã«ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å›ºå®šã—ã¦é€šä¿¡ã—ãŸã„ã€ã¨ã„ã†è¦æœ›ãŒã‚ã‚Šèª¿ã¹ã¾ã—ãŸã€‚
èª¿ã¹ã¦ã„ãä¸­ã§ã€ã¾ã¨ã¾ã£ã¦ã„ã‚‹è¨˜äº‹ãŒãªãã¦å›°ã£ãŸã®ã§ã€å‚™å¿˜ã‚‚ã‹ã­ã¦æ›¸ãã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ãŒä½•ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚